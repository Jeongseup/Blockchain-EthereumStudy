<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My New Project</title>

    <!-- web3.js -->
    <script type="text/javascript" src="./lib/bignumber.min.js"></script>
    <script type="text/javascript" src="./lib/web3.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="mycss.css">


    <style>
        #introduction {
            /* border: 5px solid red; */
            position: relative;
            width: 50%;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>

<body onload="init();">
    <nav>
        <ul>
            <li><a href="page1.html">Page1</a></li>
            <li><a href="page2.html">Page2</a></li>
        </ul>
    </nav>
    <div>
        <a class="customBtn blue" href="#blue" onclick="getGivers();">Givers</a>
        <a class="customBtn red" href="#red" onclick="getBalanceOf();">MyToken</a>
        <a class="customBtn red" href="" onclick="getArtsByOwner();">getArtsByOwner</a>

        <div class="input-group col-3 p-3 fs-6">
            <input type="text" class="form-control" placeholder="Art Name" value="Cinderella" />
            <input type="text" class="form-control" placeholder="Art CreatedBy" value="seup" />
            <input type="text" class="form-control" placeholder="Art InspiredBy" value="princess" />
            <button class="btn btn-secondary" type="button" id="button-addon2" onclick="createArt();">
                CreateArt
            </button>
        </div>

        <div class="input-group col-3 p-3 fs-6">
            <input id="input_artname" type="text" class="form-control" placeholder="Art Name" />
            <input id="input_artcreatedby" type="text" class="form-control" placeholder="Art CreatedBy" />
            <input id="input_artinspiredby" type="text" class="form-control" placeholder="Art InspiredBy" />
            <button class="btn btn-secondary" type="button" id="button-addon2" onclick="createArt();">
                CreateArt
            </button>
        </div>
    </div>
    <main>
        <section class="scene one">
            <div id="introduction" class="flex-40 d-flex align-content-center">
                <div class="row justify-content-center flex-wrap">
                    <!-- flex-50 -->
                    <div class="">
                        <div class="p-3 text-white text-center">
                            <blockquote class="blockquote">
                                <h1 class="display-1">The Givers Project</h1>
                            </blockquote>
                            <p class="text-white blockquote-footer mt-3">
                                <em>
                                    Donate directly to social good projects with zero added fees.
                                </em>
                            </p>
                            <div class="p-3 text-white text-end">
                                <p id="p_totalgivers" class="h3"></p>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button id="btn_connectwallet" type="button" class="btn btn-lg btn-secondary"
                                    onclick="connectWallet();">
                                    Connect Wallet
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- flex-50 -->
                    <div class="row justify-content-center">
                        <div class="" style="width: 90%;">
                            <div class="input-group col-sm-3 p-3">
                                <input id="input_nickname" type="text" class="form-control"
                                    placeholder="Input your nickname, if not it's replaced to none" />
                                <button class="btn btn-secondary" type="button" id="button-addon2" onclick="donate();">
                                    Donate
                                </button>
                            </div>
                            <div class="input-group col-3 p-3 fs-6">
                                <input id="input_info1" type="text" class="form-control" placeholder="Nickname" />
                                <input id="input_info2" type="text" class="form-control" placeholder="Address" />
                                <input id="input_info3" type="text" class="form-control" placeholder="Amount" />
                                <button class="btn btn-secondary" type="button" id="button-addon2"
                                    onclick="getLatestGiver();">
                                    Latest Giver
                                </button>
                            </div>
                            <div class="input-group col-3 p-3">
                                <input id="input_count" type="text" class="form-control"
                                    placeholder="Your Give Count" />
                                <button class="btn btn-secondary" type="button" id="button-addon2"
                                    onclick="getMyGiveCount();">
                                    My Give Count
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div>
        <button></button>
    </div>
    <div class="" id="columns">
        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/cinderella.jpg">
            <figcaption>Cinderella wearing European fashion of the mid-1860’s</figcaption>
            <button>Get This</button>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/rapunzel.jpg">
            <figcaption>Rapunzel, clothed in 1820’s period fashion</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/belle.jpg">
            <figcaption>Belle, based on 1770’s French court fashion</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/mulan_2.jpg">
            <figcaption>Mulan, based on the Ming Dynasty period</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/sleeping-beauty.jpg">
            <figcaption>Sleeping Beauty, based on European fashions in 1485</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/pocahontas_2.jpg">
            <figcaption>Pocahontas based on 17th century Powhatan costume</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/snow-white.jpg">
            <figcaption>Snow White, based on 16th century German fashion</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/ariel.jpg">
            <figcaption>Ariel wearing an evening gown of the 1890’s</figcaption>
        </figure>

        <figure>
            <img src="//s3-us-west-2.amazonaws.com/s.cdpn.io/4273/tiana.jpg">
            <figcaption>Tiana wearing the <i>robe de style</i> of the 1920’s</figcaption>
        </figure>
    </div>


    <footer>

        <section class="scene">

        </section>
    </footer>
    <!-- Javascript Code -->
    <script type="text/javascript" src="./src/contract.js"></script>
    <script type="text/javascript">
        let provider;
        let web3;
        let account;


        // init Contract => getContract(), getTotalGivers()
        async function init() {

            // contract.js import cofirm

            console.log("Donate Application Binary Interface is ", donateABI);
            console.log("Donate Contract Address is ", donateCA);

            console.log("Token Application Binary Interface is ", tokenABI);
            console.log("Token Contract Address is ", tokenCA);

            console.log("Factory Application Binary Interface is ", factoryABI);
            console.log("Factory Contract Address is ", factoryCA);

            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {

                    // connect 
                    await getContract();
                    await getTotalGivers();

                } catch (error) {
                    console.log(error);
                }
            }
            // Legacy dapp browsers...
            else if (window.web3) {
                // Use Mist/MetaMask's provider.
                web3 = window.web3;
                console.log("Injected web3 detected.");
            }
        }

        // init Contract
        function getContract() {
            console.log("getContract Compute!")

            dContract = new web3.eth.Contract(donateABI, donateCA);
            console.log("Donate Contract Connected!")

            tContract = new web3.eth.Contract(tokenABI, tokenCA);
            console.log("Token Contract Connected!")

            fContract = new web3.eth.Contract(factoryABI, factoryCA);
            console.log("Factory Contract Connected!")


            dContract.events.Donate({}, function (error, event) {
                    console.log("Now on, Watching Contract events!");

                    if (!error)
                        console.log(event);
                })
                .on('data', function (event) {
                    console.log(event); // same results as the optional callback above
                });
        };

        function getTotalGivers() {
            console.log("Use getTotalGivers function!");

            dContract.methods.getTotalGivers().call({}).then(function (result) {
                // console.log(result);
                document.getElementById("p_totalgivers").innerText = `Current Total Givers are ${result}!`;
            });
        };

        // 사용자 지갑에 연결합니다.
        async function connectWallet() {
            console.log("Use connectWallet function!");

            // Request account access if needed
            await window.ethereum.enable();

            // get balacne in connected account
            web3.eth.getAccounts().then(function (accounts) {
                account = accounts[0]
                console.log("Login Address is :", account);

                web3.eth.getBalance(account).then(function (balance) {

                    // parse & convert balacne
                    var sBalance = web3.utils.fromWei(String(balance), "ether").slice(0, 8);
                    console.log(sBalance);

                    var item = document.getElementById("btn_connectwallet");
                    item.innerText = "Connected";
                    item.classList.add("disabled");

                    // document.getElementById("input_mybalacne").innerHTML =
                    //     `<h3> Your Current Balane is ${balance} ether !<h3>`;
                });
            });
        }

        // 가장 최근에 기부한 사람의 정보를 가져옵니다.
        function getLatestGiver() {
            console.log("Use getLatestGiver function!");

            //contract call
            dContract.methods.getLatestGiver().call({}).then(function (result) {
                console.log(result);
                let _nickName = result[0] == "" ? "none" : result[0];
                let _account = result[1];


                let _balance = web3.utils.fromWei(String(result[2]), "ether").slice(0, 8);

                document.getElementById("input_info1").value = _nickName;
                document.getElementById("input_info2").value = _account;
                document.getElementById("input_info3").value = _balance + " ETH";
            });
        }

        // 나의 기부 횟수를 확인합니다.
        function getMyGiveCount() {
            if (account == undefined) {
                return window.alert("Connect your wallet!");
            }
            console.log("Use getMyGiveCount function!");

            dContract.methods.getMyGiveCount().call({
                from: account
            }).then(function (result) {
                console.log(result);
                document.getElementById("input_count").value = result;
            });
        }

        // 기부 합니다.
        function donate() {
            if (account == undefined) {
                return window.alert("Connect your wallet!");
            } else {

                let _nickName = document.getElementById("input_nickname").value;

                dContract.methods.donate(_nickName).send({
                        from: account,
                        value: web3.utils.toWei("1", "finney"),
                        // gas: 200000,
                        // gasPrice:
                    })
                    .on('transactionHash', function (hash) {
                        // console.log(hash);
                    })
                    .on('receipt', function (receipt) {
                        console.log(receipt);
                    })
                    .on('error', function (error, receipt) {
                        console.log(error, receipt);
                    });
            }
        };

        // 기부자들의 정보를 테이블로 가져옵니다.
        function getGivers() {
            console.log("Use getGivers function");

            //contract call
            dContract.methods.getGivers().call({}).then(function (result) {
                console.table(result);
            });
        };

        function getBalanceOf() {
            console.log("Use BalanceOf function!");

            _tokenOwner = account;
            console.log(_tokenOwner);
            tContract.methods.balanceOf(_tokenOwner).call({}).then(function (result) {
                console.log("your token balance is", result);
            });
        }

        /*
        // function name : createArt
        // arg1 : string memory _name
        // arg2 : string memory _createdBy
        // arg3 : string memory _inspiredBy
        */
        function createArt() {
            console.log("Use createArt function!");
            console.log(account);


            let _name = document.getElementById("input_artname").value;
            let _createdBy = document.getElementById("input_artcreatedby").value;
            let _inspiredBy = document.getElementById("input_artinspiredby").value;

            console.log(_name, _createdBy, _inspiredBy);

            fContract.methods.createArt(_name, _createdBy, _inspiredBy).send({
                    from: account
                })
                .on('transactionHash', function (hash) {
                    console.log(hash);
                })
                .on('receipt', function (receipt) {
                    console.log(receipt);
                })
                .on('error', function (error, receipt) {
                    console.log(error, receipt);
                });
        };
        /*
        getArtsByOwner(address _owner) external view returns(uint[] memory) {
        */
        function getArtsByOwner() {
            console.log(_owner);
            _owner = account;

            console.log(_owner);
            fContract.methods.getArtsByOwner(_owner).call({}).then(function (result) {
                console.log(result);
            })
        };
    </script>
</body>

</html>