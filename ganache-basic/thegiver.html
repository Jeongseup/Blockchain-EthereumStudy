<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <title>Document</title>
    <script type="text/javascript" src="./lib/bignumber.min.js"></script>
    <script type="text/javascript" src="./lib/web3.min.js"></script>
    <script>
        let web3 = new Web3(Web3.givenProvider || "http://localhost:8545");
        console.log(web3);

        let contractAddress = "0x8739fF30ECA3FBECc36220b654e633CD6B598Bc0";
        let abi = [{
                "anonymous": false,
                "inputs": [{
                    "components": [{
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "address",
                            "name": "account",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "balance",
                            "type": "uint256"
                        }
                    ],
                    "indexed": false,
                    "internalType": "struct donation.Givers",
                    "name": "giver",
                    "type": "tuple"
                }],
                "name": "Donate",
                "type": "event"
            },
            {
                "inputs": [{
                    "internalType": "string",
                    "name": "_nickName",
                    "type": "string"
                }],
                "name": "donate",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getGiveCount",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getLastgiver",
                "outputs": [{
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalgivers",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }
        ];


        let contract = new web3.eth.Contract(abi, contractAddress);
        console.log(contract);

        web3.eth.getAccounts(function (error, result) {
            console.table(result);
            accounts = result

            _account = accounts[0]
            document.getElementById("input_myaccount").innerHTML =
                `<h3>Your Address is ${_account}</h3>`;
        });

        function getTotalGivers() {
            let _account = accounts[0];
            console.log("from is", _account);

            contract.methods.getTotalgivers().call({}).then(function (result) {
                console.log(result);
                document.getElementById("input_totalgivers").value = result;
            });
        }

        function getLastgiver() {
            //contract call
            contract.methods.getLastgiver().call({}).then(function (result) {
                // console.table(result);
                let _nickName = result[0] == "" ? "none" : result[0];
                let _account = result[1];
                let _balance = result[2];

                document.getElementById("input_info1").value = _nickName;
                document.getElementById("input_info2").value = _account;
                document.getElementById("input_info3").value = _balance;
            });
        }

        function getGiveCount() {

            let _account = document.getElementById("input_address").value;
            console.log("from is", _account);

            contract.methods.getGiveCount().call({
                from: _account
            }).then(function (result) {
                console.log(result);
                document.getElementById("input_count").value = result;
            });
        }


        function donate() {
            let _nickName = document.getElementById("input_nickname").value;
            console.log(_account);

            contract.methods.donate(_nickName).send({
                from: _account,
                value: web3.utils.toWei("1", "ether"),
                gas: 200000
            }).then(function (result) {
                console.log(result);
            })

            // using the promise
            // contract.methods.donate(_nickName).estimateGas({
            //         from: _account,
            //         value: web3.utils.toWei("1", "ether"),
            //         gas: 6721975
            //     })
            //     .then(function (gasAmount) {
            //         console.log(gasAmount);
            //     })
            //     .catch(function (error) {
            //         console.log(error);
            //     });
        };


        // 
        //         from: ....
        //     })
        //     .on('receipt', function () {
        //         ...
        //     });
    </script>
</head>

<body>
    커버하고 싶은 사이트 : https://giveth.io/
    <div class="container row justify-content-center">
        <div id="input_myaccount"></div>
        <div class="input-group col-sm-3">
            <!-- <div class="input-group mb-3"> -->
            <input id="input_nickname" type="text" class="form-control" placeholder="Your Nickname" />
            <button class="btn btn-primary" type="button" id="button-addon2" onclick="donate();">
                Donate
            </button>
        </div>
        <div class="input-group col-3">
            <input id="input_info1" type="text" class="form-control" placeholder="Current Count" />
            <input id="input_info2" type="text" class="form-control" placeholder="Current Count" />
            <input id="input_info3" type="text" class="form-control" placeholder="Current Count" />
            <button class="btn btn-primary" type="button" id="button-addon2" onclick="getLastgiver();">
                Last Giver Information
            </button>
        </div>
        <div class="input-group col-3">
            <input id="input_totalgivers" type="text" class="form-control" placeholder="Current Count" />
            <button class="btn btn-primary" type="button" id="button-addon2" onclick="getTotalGivers();">
                Total Givers
            </button>
        </div>
        <div class="input-group col-3">
            <input id="input_address" type="text" class="form-control" placeholder="Current Count" />
            <input id="input_count" type="text" class="form-control" placeholder="Current Count" />
            <button class="btn btn-primary" type="button" id="button-addon2" onclick="getGiveCount();">
                My Give Count
            </button>
        </div>
    </div>

</body>


</html>