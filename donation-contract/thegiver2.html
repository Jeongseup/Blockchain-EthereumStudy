<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Givers</title>
    <link rel="icon" type="image/png" href="./src/logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Playfair&#43;Display:700,900&amp;display=swap" rel="stylesheet">

    <!-- web3.js -->
    <script type="text/javascript" src="./lib/bignumber.min.js"></script>
    <script type="text/javascript" src="./lib/web3.min.js"></script>

    <style>
        * {
            font-family: "Playfair Display"
        }

        .bd-highlight {
            /* 
            background-color: rgba(86, 61, 124, 0.15);
            border: 1px solid black;
            width: 100%;
             */
        }

        .bg-default {
            /* flex: 50%; */
            background-color: #196B84;
        }

        .flex-50 {
            flex: 40%;
        }

        .text-default {
            color: #196B84;
        }
    </style>
</head>

<body>
    <!-- container -->
    <div class="pt-5 d-flex">
        <!-- default bg color -->
        <div class="bg-default d-flex align-content-center flex-wrap" style="flex:40%">
            <!-- flex-50 -->
            <div class="bd-highlight">
                <div class="p-3 text-white text-end">
                    <blockquote class="blockquote">
                        <h1 class="display-3">The Givers Project</h1>
                    </blockquote>
                    <p class="text-white blockquote-footer mt-3">
                        <em>
                            Donate directly to social good projects with zero added fees.
                        </em>
                    </p>
                    <div class="d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary" onclick="connectWallet();">
                            Connect Wallet
                        </button>
                    </div>
                </div>
            </div>
            <!-- flex-50 -->
            <div class="bd-highlight">
                <!-- <div class="input-group col-sm-3 p-3">
                    <button class="btn btn-secondary" type="button" id="button-addon2" onclick="getContractBalancne();">
                        Current your Balance is
                    </button>
                </div> -->
                <div class="p-3 text-white text-end">
                    <p class="h3">
                        Current Total Givers are 3 !
                    </p>
                </div>
                <div class="input-group col-sm-3 p-3">
                    <input id="input_nickname" type="text" class="form-control" placeholder="Your Nickname" />
                    <button class="btn btn-secondary" type="button" id="button-addon2" onclick="donate();">
                        Donate
                    </button>
                </div>
                <div class="input-group col-3 p-3">
                    <input id="input_info1" type="text" class="form-control" placeholder="Current Count" />
                    <input id="input_info2" type="text" class="form-control" placeholder="Current Count" />
                    <input id="input_info3" type="text" class="form-control" placeholder="Current Count" />
                    <button class="btn btn-secondary" type="button" id="button-addon2" onclick="getLatestGiver();">
                        Latest Giver Information
                    </button>
                </div>

                <div class="input-group col-3 p-3">
                    <input id="input_address" type="text" class="form-control" placeholder="Current Count" />
                    <input id="input_count" type="text" class="form-control" placeholder="Current Count" />
                    <button class="btn btn-secondary" type="button" id="button-addon2" onclick="getMyGiveCount();">
                        My Give Count
                    </button>
                </div>
            </div>
        </div>
        <!-- img content -->
        <div style="flex:60%">
            <!-- <div class="content" style="background-image:url(./src/main-img.svg);"></div> -->
            <img src=" ./src/main-img.svg" class="img-fluid" />
        </div>
    </div>
</body>

<!-- Javascript Code -->
<script type="text/javascript" src="./src/contract.js"></script>
<script type="text/javascript">
    let provider;
    let web3;
    let account;


    async function connectWallet() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                // Request account access if needed
                await window.ethereum.enable();
                // Acccounts now exposed
                web3.eth.getAccounts().then(function (accounts) {
                    account = accounts[0]
                    console.log("Login Address is :", account);

                    // document.getElementById("input_myaccount").innerHTML =
                    // `<h3>Your Address is ${account}</h3>`;
                    getContract();

                })
            } catch (error) {
                console.log(error);
            }
        }
        // Legacy dapp browsers...
        else if (window.web3) {
            // Use Mist/MetaMask's provider.
            web3 = window.web3;
            console.log("Injected web3 detected.");
        }
    }

    // contract.js import cofirm
    console.log("My Application Binary Interface is ", abi);
    console.log("My Contract Address is ", myContractAddress);

    // init Contract
    function getContract() {
        console.log("getContract Compute!")
        myContract = new web3.eth.Contract(abi, myContractAddress);

        myContract.events.Donate({}, function (error, event) {
                console.log("Now on, Watching Contract events!");

                if (!error)
                    console.log(event);
            })
            .on('data', function (event) {
                console.log(event); // same results as the optional callback above
            });
    };



    function getTotalGivers() {
        let _account = accounts[0];
        console.log("from is", _account);

        myContract.methods.getTotalGivers().call({}).then(function (result) {
            console.log(result);
            document.getElementById("input_totalgivers").value = result;
        });
    }

    function getLatestGiver() {
        //contract call
        myContract.methods.getLatestGiver().call({}).then(function (result) {
            console.log(result);
            let _nickName = result[0] == "" ? "none" : result[0];
            let _account = result[1];
            let _balance = result[2];

            document.getElementById("input_info1").value = _nickName;
            document.getElementById("input_info2").value = _account;
            document.getElementById("input_info3").value = _balance;
        });
    }

    function getMyGiveCount() {

        let _account = document.getElementById("input_address").value;
        console.log("from is", _account);

        myContract.methods.getMyGiveCount().call({
            from: _account
        }).then(function (result) {
            console.log(result);
            document.getElementById("input_count").value = result;
        });
    }


    function donate() {
        let _nickName = document.getElementById("input_nickname").value;
        // console.log(_account);

        myContract.methods.donate(_nickName).send({
                from: account,
                value: web3.utils.toWei("1", "finney"),
                // gas: 200000,
                // gasPrice:
            })
            .on('transactionHash', function (hash) {
                // console.log(hash);
            })
            .on('receipt', function (receipt) {
                console.log(receipt);
            })
            .on('error', function (error, receipt) {
                console.log(error, receipt);
            });
    };

    function getContractBalancne() {
        web3.eth.getBalance(myContractAddress)
            .then(function (result) {
                console.log(result);
                document.getElementById("input_contractbalance").value = result;
            })
    };
</script>

</html>